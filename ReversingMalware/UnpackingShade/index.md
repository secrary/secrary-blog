---
layout: REpost
title: "Unpacking Shade Ransomware"
---

I'm trying to unpack `Shade` ransomware, the sample is relatively new `2017-11-01`: <a href="https://www.virustotal.com/en/file/c02153dce99eb8730806cfe19a3f29e3d4e3fad796f4eb15962b74fb2e55fe47/analysis/" target="_blank">c02153dce99eb8730806cfe19a3f29e3d4e3fad796f4eb15962b74fb2e55fe47</a>.

For behavior analysis we can use report from <a href="https://www.hybrid-analysis.com/sample/a55edfe9847915a7f2a505f928be7bfc7a867ba226e3578fd768ab4a423aa62a?environmentId=100" target="_blank">hybrid-analysis.com</a>.

It uses `NSIS` which helps developers to create Windows installers: 

`NSIS (Nullsoft Scriptable Install System) is a professional open source system to create Windows installers. It is designed to be as small and flexible as possible and is therefore very suitable for internet distribution.`

![1](https://user-images.githubusercontent.com/16405698/32437594-506d4b3a-c301-11e7-8c06-7cd0c234570d.PNG)

We can extract `.nsi` script from the installer and analyze this, instead of working with the executable. We need `7-zip 15.05` due to after that version `7-zip` does not supports extracting `.nsi` script files.

![2](https://user-images.githubusercontent.com/16405698/32437596-50c37ab4-c301-11e7-9e3b-6a2d0a95fbfa.PNG)

You can download extracted script from the Gist <a href="https://gist.github.com/anonymous/ee03e53ec9bf70297052c83099157965" target="_blank">link</a>.

Seems like this script is modified version of a script for a legitimate tool called `smartmontools`, all malicious calls are at `.onInit`, which executes when we open the executable. 

It uses `System` plugin from `NSIS`, which is very powerful one (the plugin is packed into the original executable and called `system.dll`), you can call any function from any `dll` via the plugin.

![3](https://user-images.githubusercontent.com/16405698/32437598-50ecf1fa-c301-11e7-964b-446a72088b49.PNG)

For example, `System::Call "kernel32::GetModuleHandle(t 'user32.dll') p .s"`, it's kind of proxy, we need to understand the script to get idea what happens, for more information about the plugin, visit <a href="http://nsis.sourceforge.net/Docs/System/System.html" target="_blank">official page</a>.

I recreate malicious part of the script and add some comments, it helps you to understand how the malware works:

<script src="https://gist.github.com/a333a2f5c897b8fa0ccd47c58494cd60.js"></script>

We can set a breakpoint at `System::Call` function and when it calls the last function `System::Call "$5p r13, i 863248)"`, it jumps to destination address:

![4](https://user-images.githubusercontent.com/16405698/32437599-5115a3ca-c301-11e7-92eb-04425c0e076e.PNG)


Now we are inside shellcode:

![5](https://user-images.githubusercontent.com/16405698/32437600-5141edd6-c301-11e7-8273-af7b4c076ce7.PNG)

#### `Note: there are different destination/start of shellcode addresses, due to screenshots are from different tries`


From there it finds necessary function addresses and decrypts part of included file - `779973275`, the shellcode is also part of the file.
The decrypted data is `PE` file:

![6](https://user-images.githubusercontent.com/16405698/32437601-51727ba4-c301-11e7-8483-00dd4916174b.PNG)

![7](https://user-images.githubusercontent.com/16405698/32437603-5197abe0-c301-11e7-9a70-1ec92aa7004f.PNG)

After that it uses `process hollowing` technique to execute decrypted file:

![8](https://user-images.githubusercontent.com/16405698/32437604-51c28946-c301-11e7-8328-3c0c6a97ed84.PNG)

##### `Note: for more information about `process hollowing` you can read my previous posts`


The extracted file is packed with normal `UPX`, which is very simple to unpack.

You can download extracted and unpacked sample of `shade ransomware` from <a href="https://www.hybrid-analysis.com/sample/dba88e22f0763e2475c366c066928d5df4b507366598e76bc45f85d056d9bc5c?environmentId=100" target="_blank">`hybrid-analysis`</a> and/or <a href="https://www.virustotal.com/en/file/dba88e22f0763e2475c366c066928d5df4b507366598e76bc45f85d056d9bc5c/analysis/" target="_blank">`virustotal`</a>.


Any feedback appreciated.

Twitter: [@_qaz_qaz](https://twitter.com/_qaz_qaz)
