---
layout: REpost
title: "Unpacking GandCrab Ransomware"
---

Relatively new sample of `GandCrab` ransomware, I got it from [`ANY.RUN`](https://any.run/)

![0](https://user-images.githubusercontent.com/16405698/35470151-eeec2d2e-033b-11e8-80c0-bfaedb134025.PNG)

SHA256: `643F8043C0B0F89CEDBFC3177AB7CFE99A8E2C7FE16691F3D54FB18BC14B8F45`

It's `light post` about unpacking aforementioned malware.

`GandCrab` uses `GlobalAlloc` to allocate memory, uses `40120B` and `4011EO` functions to decrypt and/or decode a code, after changing protection to `PAGE_EXECUTE_READWRITE` via `VirtualProtect`, it jumps to previously allocated memory: `call dword ptr ss:[ebp-68]`

![1](https://user-images.githubusercontent.com/16405698/35470152-ef370f6a-033b-11e8-8dad-4c064369da96.PNG)

After jumping, it uses the first function to locate `GetProcAddress` and `LoadLibrary`, and the second function to build IAT and jump to unpacked sample:

![2](https://user-images.githubusercontent.com/16405698/35470153-ef75941a-033b-11e8-9427-7d359cb29e34.PNG)

Locate `kernel32`:

![3](https://user-images.githubusercontent.com/16405698/35470154-efd75dc6-033b-11e8-80e9-3ecbcfc6e2ef.PNG)

Locate `GetProcAddress` and `LoadLibrary`:

![4](https://user-images.githubusercontent.com/16405698/35470155-f0270b78-033b-11e8-8a35-2713807ccbfe.PNG)


![5](https://user-images.githubusercontent.com/16405698/35470156-f0854c06-033b-11e8-9ab8-533a52141f9a.PNG)

Locate necessary functions:

![7](https://user-images.githubusercontent.com/16405698/35470142-ecfd513c-033b-11e8-9543-db2a27d87256.gif)

Changes protection of 0x400000 (ImageBase) and removes everything from it:

![8](https://user-images.githubusercontent.com/16405698/35470226-31c8013a-033d-11e8-97d9-0d03a1a84ce7.gif)

Uses different function (0x264D62E at this run) to map new sections:

![9](https://user-images.githubusercontent.com/16405698/35470144-ed5e0cf2-033b-11e8-9ce9-fcaddfea9711.PNG)

Locates IAT for recently mapped PE:

![10](https://user-images.githubusercontent.com/16405698/35470145-ed87626e-033b-11e8-8393-2033e563345b.gif)

...and so on, at the end, it jumps to the code:

![6_jmp_eax](https://user-images.githubusercontent.com/16405698/35470141-eccc05d2-033b-11e8-851d-e533cc3e66b0.PNG)

Which is at `0x4044A5`, this address was used by different code before unmap old code and map new one, `x32dbg` handles well:

![11](https://user-images.githubusercontent.com/16405698/35470146-edbf116e-033b-11e8-8927-e83167132963.PNG)

but at `IDA` we get broken disassembly:

![12](https://user-images.githubusercontent.com/16405698/35470147-edfd2774-033b-11e8-809a-77b11d547171.PNG)

![14](https://user-images.githubusercontent.com/16405698/35470148-ee462258-033b-11e8-88fe-561668e8ae30.PNG)

We can use `Scylla` to dump unpacked version of the ransomware

![15](https://user-images.githubusercontent.com/16405698/35470149-ee881f3c-033b-11e8-9b04-88565dbb6bd6.PNG)

...Now it's better:

![16](https://user-images.githubusercontent.com/16405698/35470150-eeae3992-033b-11e8-8a3b-19cf6037379d.PNG)



Any feedback appreciated: [@_qaz_qaz](https://twitter.com/_qaz_qaz)