---
layout: REpost
title: "Trojan Enosch"
---

SHA256: `e09bb7d13702e7afc9a8bd49b4fe997deb61e439cdf8a055ac1bfce50cbdb417`


File type: Win32 EXE

Let's open in [ProtectionID](https://pid.gamecopyworld.com/):

![1](https://user-images.githubusercontent.com/16405698/27454990-ea0f47c2-57ac-11e7-9ef7-c9e82d8d0747.PNG)

We have malware written in C++ without obfuscation and protection, 
I get the sample from [hybrid-analysis](https://www.hybrid-analysis.com/sample/e09bb7d13702e7afc9a8bd49b4fe997deb61e439cdf8a055ac1bfce50cbdb417), 
also there is a good summery about the malware on [Sophos webpage](https://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/Troj~Enosch-A/detailed-analysis.aspx).


From imports, it seems like malware uses Windows crypto API:

![2](https://user-images.githubusercontent.com/16405698/27455024-0475dcca-57ad-11e7-9ee2-b94f0f340d88.PNG)

Very interesting strings in the file:

![3](https://user-images.githubusercontent.com/16405698/27455026-04769746-57ad-11e7-9713-97fd04f29065.PNG)

[Chilkat](https://chilkatsoft.com/) is a cross-language, cross-platform API providing 90+ classes for many Internet protocols, formats, and algorithms.
Maybe malware uses this library to provide some high-level abstraction.

It's possible Crypto API is used by `Chilkat`.


 
Based on [SSMA](https://github.com/secrary/SSMA) there are two possible emails, maybe `Chilkat` is used to send emails.

![4](https://user-images.githubusercontent.com/16405698/27455025-0476045c-57ad-11e7-85b1-edc1ca784ea2.PNG)

Instead of running in our sandbox, let's use [hybrid-analysis](https://www.hybrid-analysis.com/sample/e09bb7d13702e7afc9a8bd49b4fe997deb61e439cdf8a055ac1bfce50cbdb417) 
report to guide us on the deeper analysis.

From the analysis, the malware uses `Run` key as persistence method and requests two domains: `smtp.gmail.com` and `google.fr`


I think to get an idea how to works the malware we even don't need to run it (debug it), just open in `IDA` and disassemble it.

First, it checks `Run` key and sets it if there is no `gtalkupdate`:

![5](https://user-images.githubusercontent.com/16405698/27455028-04777e86-57ad-11e7-8d21-5bf4fbe42e24.PNG)

![6](https://user-images.githubusercontent.com/16405698/27455029-047a0962-57ad-11e7-8659-58716c8561b9.PNG)

![7](https://user-images.githubusercontent.com/16405698/27455027-04778b92-57ad-11e7-9f9f-4418ae6a4050.PNG)

...executes two threads with same `StartAddress` - `sub_401710` and waits for them, that's all:

![8](https://user-images.githubusercontent.com/16405698/27455030-0491ce4e-57ad-11e7-9a9c-1976e4e50c27.PNG)

Let's see what's inside  `sub_401710` function.


The malware loops until successful internet connection and gets a list of drives:

![9](https://user-images.githubusercontent.com/16405698/27455033-0494973c-57ad-11e7-8a1b-53ea68f4b990.PNG)

Snippet from `WaitUntilConnection`:

![10](https://user-images.githubusercontent.com/16405698/27455031-049325c8-57ad-11e7-95bd-5a1a05dd2945.PNG)

Connect to `Google`:

![11](https://user-images.githubusercontent.com/16405698/27455032-0494112c-57ad-11e7-8ab2-6b82a0630442.PNG)

![18_google](https://user-images.githubusercontent.com/16405698/27456572-a3104a32-57b2-11e7-8dd7-ac99c58ca22a.PNG)

After this for each drive malware searches and sends `.doc` and `docx` to an attacker using mail, I renamed function accordingly:

![12](https://user-images.githubusercontent.com/16405698/27455034-0495d12e-57ad-11e7-9ad5-6cbd2d3a6231.PNG)

If the entry is directory function is called recursively:

![13](https://user-images.githubusercontent.com/16405698/27455035-04969fdc-57ad-11e7-8f2c-8a21ff19d6f3.PNG)

![14](https://user-images.githubusercontent.com/16405698/27455036-04ade930-57ad-11e7-9e7c-e5ec2f12c45f.PNG)

Check if file's extension is `.doc` or `docx` :

![15](https://user-images.githubusercontent.com/16405698/27455037-04ae57f8-57ad-11e7-8769-5e97a69a7c44.PNG)

....and send the file using mail, there are many unknown functions, maybe they are from third-party library `Chilkat`:

![16](https://user-images.githubusercontent.com/16405698/27455038-04b1c38e-57ad-11e7-8b16-c42fa8808ba0.PNG)

There are `Yahoo` mail and `GetComputerNameA` function, after running with `fakenet` it seems like `Yahoo` is recipient's mail and result of `GetComputerNameA` is subject of mail:

![17](https://user-images.githubusercontent.com/16405698/27455039-04b4c228-57ad-11e7-841a-1e34506bb8f3.PNG)

![19_mail](https://user-images.githubusercontent.com/16405698/27455041-04b82f4e-57ad-11e7-9d55-81963e4badf8.PNG)

That's all. I'm new to reversing malware and any kind of feedback will be helpful for me.


Twitter: [@_qaz_qaz](https://twitter.com/_qaz_qaz)
