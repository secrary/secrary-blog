---
layout: REpost
title: "Remcos RAT"
---

**[Remcos Remote Control](https://breaking-security.net/remcos/ "Remcos Remote Control")** - `Control remotely your computers, anywhere in the world.`

------------

I'm using the free version of `Remcos` and using `MPRESS` as a packer.

![remcos](https://user-images.githubusercontent.com/16405698/27761126-2878ccf2-5e67-11e7-9cba-3b64ee492b7b.PNG)

You can download sample from [hybrid-analysis.com](https://www.hybrid-analysis.com/sample/4cb1cf94bb899dc0a8115bbb644f517612201debf2a7809d30ee89ec58aad902?environmentId=100 "hybrid-analysis.com")

As wee see it's packed with [MPRESS](http://www.matcode.com/mpress.htm "MPRESS"):

![protID](https://user-images.githubusercontent.com/16405698/27761173-247e1296-5e68-11e7-984b-5cd7c640ce78.png)

Let's look at it's behavior, [procmon](https://technet.microsoft.com/en-us/sysinternals/processmonitor):

![procmon](https://user-images.githubusercontent.com/16405698/27761225-d78b15e6-5e68-11e7-821c-e8032fb709f8.png)

It creates folder `remcos` and PE file named `remcos.exe` in `%APPDATA%` directory, `remcos` uses `Run` key as persistence method, also creates file called `install.bat` in `%TEMP%` directory.

From `hybrid-analysis` we get almost same information:

![hybrid-analysis](https://user-images.githubusercontent.com/16405698/27761252-58359356-5e69-11e7-8e9c-cd6d33bd5244.png)

`install.bat` pings C&C, executes `remcos.exe` from `%APPDATA%` directory, and removes itself:

![install.bat](https://user-images.githubusercontent.com/16405698/27761281-f027d02a-5e69-11e7-981d-696fa5993192.png)

After this, we can connect to our C&C, we control the machine:

![image](https://user-images.githubusercontent.com/16405698/27761291-34840202-5e6a-11e7-85e7-7af5e0fdd6f9.png)

Let's dive deep and open in `IDA Pro`:

![ida](https://user-images.githubusercontent.com/16405698/27761311-a41541bc-5e6a-11e7-9afd-7badfc24c309.png)

What?! such a few functions, suspicious entry point, few imports, high entropy, they are signs of the packed executable:

![imports](https://user-images.githubusercontent.com/16405698/27761331-e3bc83d4-5e6a-11e7-8d5d-afbb4094c870.png)

![entropy](https://user-images.githubusercontent.com/16405698/27761351-5166afc2-5e6b-11e7-9909-89c8fb872fd1.png)

Let's open in `x32dbg` and unpack it.

`MPRESS makes programs and libraries smaller, and decrease start time when the application loaded from a slow removable media or from the network.` 

`MPRESS` is a generic packer, it's not created for protecting applications, because of it, it's very easy to unpack apps packed with it.

At the entry point, there is `pushad` instruction, it's very common for packers, such as `UPX`,
it saves all register values at the stack and after unpacking application it restores using `popa(d)` instruction.

![x32dbg](https://user-images.githubusercontent.com/16405698/27761382-d4988b5e-5e6b-11e7-8787-1657fa7c73c4.png)

There are many ways to unpack such packed files, let's use one of them, after saving register values at the stack, set the hardware breakpoint at any pushed register values and run:

![unpack](https://user-images.githubusercontent.com/16405698/27761422-9c31b5a0-5e6c-11e7-9cc9-20c7b21399f3.png)

...and we hit `popad` instruction: 

![image](https://user-images.githubusercontent.com/16405698/27761430-c1110f38-5e6c-11e7-88c1-98a29658490c.png)

Let's follow to `jmp`, probably there are unpacked instructions:

![image](https://user-images.githubusercontent.com/16405698/27761450-15d6b5b8-5e6d-11e7-9670-7f1bf72bcfd0.png)

There is `except_handler3` from `C++` and several other normal functions. Seems like it's unpacked.

Let's dump it using `x32dbg`'s built-in plugin `Scylla`.

Plugin->Scylla->IAT Autosearch->Get Imports->Dump->Fix Dump

![dump](https://user-images.githubusercontent.com/16405698/27761475-7f9b6e58-5e6d-11e7-935f-db4b03564916.png)

...and open in `IDA pro`:

![image](https://user-images.githubusercontent.com/16405698/27761478-a78fd53e-5e6d-11e7-83d4-24424efa54f7.png)

There are `WinMain` and `std` functions, it's unpacked, you can download unpacked version from [hyberid-analysis](https://www.hybrid-analysis.com/sample/fc182e1b64310a0dd65f01ccfb84d2d4e4da45a838be4cb061397591e8905023?environmentId=100 "hyberid-analysis").

**Open unpacked sample in `IDA pro` and dive deep**.

In `WinMain` function it checks command line arguments, and if there is `-l` option it creates `lic.txt` file:

![image](https://user-images.githubusercontent.com/16405698/27761639-42c751d2-5e71-11e7-8aa7-b63b1d52a545.png)

At `00403BC7` it creates Mutex, and if there is one, it terminates itself:

![image](https://user-images.githubusercontent.com/16405698/27761652-77f01c54-5e71-11e7-9270-0d2ec3def7ad.png)

At `00403BDE` gets function addresses using `LoadLibraryA`, `GetProcAddress`, at `00403C09` gets product name from `SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProductName`, at `00403C28` checks if process is under 64-bit windows:

![image](https://user-images.githubusercontent.com/16405698/27761696-37efdb66-5e72-11e7-81c9-1671d423eafa.png)

![productname](https://user-images.githubusercontent.com/16405698/27763606-6e1453f0-5e97-11e7-87e2-45d2142f88ae.PNG)

![image](https://user-images.githubusercontent.com/16405698/27761704-57b4e202-5e72-11e7-8723-a6db9ca96270.png)

Checks if the process is executed with admin privileges:

![image](https://user-images.githubusercontent.com/16405698/27761716-92ca0b74-5e72-11e7-8486-b685a4e0150b.png)

Possibly, RAT will send this information to C&C.

Seems like at `00403D5D` function gets directory path based on configuration:

![image](https://user-images.githubusercontent.com/16405698/27761741-33126608-5e73-11e7-89b1-bcd0ba461fcc.png)

Function at `00403DEB` creates directory `remcos` and copies file into it:

![image](https://user-images.githubusercontent.com/16405698/27761759-aeec36a0-5e73-11e7-88a0-4d6803babdc5.png)

Creates `install.bat` in `%TEMP%` directory:

![image](https://user-images.githubusercontent.com/16405698/27761777-139e4232-5e74-11e7-986e-19ac5fded4ed.png)

...and fills with following code:

![image](https://user-images.githubusercontent.com/16405698/27761794-5cdd0d70-5e74-11e7-8c8c-5c6657791507.png)

After successfull execuation application exits:

![image](https://user-images.githubusercontent.com/16405698/27761799-906fb9d0-5e74-11e7-8091-50bbc66907af.png)

`install.bat` creates new instance of `remcos.exe` from `%APPDATA%` directory:

![image](https://user-images.githubusercontent.com/16405698/27761863-80393d28-5e76-11e7-8316-04c44c9dc7d5.png)

If we want to get information what happens when `install.bat` executes `remcos.exe` we must patch instruction at `00403D7A` or manualy jump to `loc_403DFA`:

![image](https://user-images.githubusercontent.com/16405698/27761873-c2169d3a-5e76-11e7-9d98-b9fce4a7dda8.png)


At `00403E82` function adds one more entry in registry:

![image](https://user-images.githubusercontent.com/16405698/27761954-a5a6c272-5e78-11e7-9aec-5c60e2b9a6f0.png)

Seems like the value of `EXEpath` is the encrypted path to original executable:

Before encrypt:

![image](https://user-images.githubusercontent.com/16405698/27761980-fa4e0664-5e78-11e7-9fbf-d3ddfb9f0be3.png)

Before set value:

![image](https://user-images.githubusercontent.com/16405698/27762045-6ed9655e-5e7a-11e7-9e2a-79444201218d.png)

Application disables `DEP` and calls function which is some kind of loop:

![image](https://user-images.githubusercontent.com/16405698/27762124-5641d0c4-5e7c-11e7-929d-1ee1f3ff97e4.png)


Let's see what's inside function, which is called at `00403F14`.
Seems like it set ups connection:

![image](https://user-images.githubusercontent.com/16405698/27762140-9f3f5d96-5e7c-11e7-8500-6f9ebe1a4ffb.png)

The most important call is at `00406277`:

![image](https://user-images.githubusercontent.com/16405698/27762148-db3ced9a-5e7c-11e7-9d3d-60e0c9ac98ed.png)

`recv_and_exec` function recievs commands and executes them:

![image](https://user-images.githubusercontent.com/16405698/27762153-0b238186-5e7d-11e7-9008-1d4ce01c5b37.png)

`lpStartAddress` is passed as an argument to `recv_and_exec`, let's investigate it,
`RunCommands` function at `00406371` is a core of the RAT, it executes commands from C&C.
It's C&C panel:

![image](https://user-images.githubusercontent.com/16405698/27762172-afd5b5e6-5e7d-11e7-8d37-b9483b8ddaaf.png)

`RunCommands` is kind of switch statement, there are following possible values: *filemgr, downloadfromurltofile, downloadfromlocaltofile, getproclist, prockill, getwindows, closewindow, maxwindow, restorewindow, closeprocfromwindow, execcom, consolecmd, openaddress, initializescrcap, freescrcap, deletefile, close, uninstall, updatefromurl, updatefromlocal, msgbox, keyinput, mclick, OSpower, getclipboard, setclipboard, emptyclipboard, dlldata, dllurl, initfun, initremscript, initregedit, renamebck, initsocks, SetSuspendState.*

Let's investagete some of them.
- *filemgr* uses `FindFirstFileW`, `FindNextFileW` to list files:

![image](https://user-images.githubusercontent.com/16405698/27762360-946bebfa-5e81-11e7-8849-90f89f5f5d19.png)

inside *filemgr* there are several other commands, such as `newfolder`, `upload`, `download` etc.

![image](https://user-images.githubusercontent.com/16405698/27762364-c27dc130-5e81-11e7-96f4-1b9fb62fb2cd.png)

C&C:

![image](https://user-images.githubusercontent.com/16405698/27762392-4c34de22-5e82-11e7-81e4-113dfe056b90.png)


- *downloadfromurltofile* downloads from url and executes it:

![image](https://user-images.githubusercontent.com/16405698/27762376-0373e232-5e82-11e7-8bb6-5c0a2ac48305.png)
*downloadfromurltofile* downloads file from C&C, saves to %TEMP% directory and executes it:

![image](https://user-images.githubusercontent.com/16405698/27762414-a6cc299e-5e82-11e7-8c5d-303b388ffcfe.png)

![image](https://user-images.githubusercontent.com/16405698/27762426-f4564b2c-5e82-11e7-8b8f-93b3c4f181b9.png)

C&C:

![image](https://user-images.githubusercontent.com/16405698/27762406-8be29c6c-5e82-11e7-98bf-352da6dd9e74.png)

- *getproclist* lists processes using `CreateToolhelp32Snapshot`, `Process32FirstW`, `Process32NextW` functions:

![image](https://user-images.githubusercontent.com/16405698/27762436-3fc3c04e-5e83-11e7-90d9-bcbb50f3d3e2.png)

- *prockill* determines a process using `TetermineProcess` function:

![image](https://user-images.githubusercontent.com/16405698/27762453-94800fac-5e83-11e7-8c30-4b675cd5bd97.png)

- *getwindows*, *closewindow*, *maxwindow*, *restorewindow*, *closeprocfromwindow* used to manipuate windows:

![image](https://user-images.githubusercontent.com/16405698/27762492-e9da552a-5e83-11e7-8132-709b3bb84429.png)

![image](https://user-images.githubusercontent.com/16405698/27762506-41919152-5e84-11e7-92c8-a2f4b6f1dcf1.png)

- *execcom* executes commands:

![image](https://user-images.githubusercontent.com/16405698/27762524-8ba5e158-5e84-11e7-8130-8a126e92c68a.png)

- *consolecmd* to get command prompt:

![capture](https://user-images.githubusercontent.com/16405698/27762532-bf8c5308-5e84-11e7-8e20-db1dd327c39a.PNG)

- *openaddress* opens web-page:

![image](https://user-images.githubusercontent.com/16405698/27762544-01ba527a-5e85-11e7-87a6-a787f5a4e9c5.png)

- *initializescrcap* uses many image functions([msdn](https://msdn.microsoft.com/en-us/library/windows/desktop/ms534041(v=vs.85).aspx "msdn")) and used to capture screen.
*freescrcap* is called when we close Capture window at C&C panel:

![image](https://user-images.githubusercontent.com/16405698/27762595-43f1071e-5e86-11e7-9e41-0deb16ab614e.png)

- *deletefile* and *close* are easy to guess:

![image](https://user-images.githubusercontent.com/16405698/27762630-1435e502-5e87-11e7-91d9-28f51b23ce5c.png)

- *uninstall* removes value from `Run` key:

![image](https://user-images.githubusercontent.com/16405698/27762639-3d0595b8-5e87-11e7-8a03-2ed7edeaf158.png)

Creates `Uninstall.bat` in %TEMP% directory and runs it:

![image](https://user-images.githubusercontent.com/16405698/27762672-9224acd2-5e87-11e7-980b-1eddfac2ab5c.png)

- *updatefromurl* downloads file from internet and changes all old files and registry entries:

![image](https://user-images.githubusercontent.com/16405698/27762700-0182e68e-5e88-11e7-9bea-d5aa53b7f41c.png)

..and runs `update.bat`:

![image](https://user-images.githubusercontent.com/16405698/27762871-c6085f78-5e8a-11e7-8626-aa9497000a2b.png)

- *updatefromlocal* is almost same as *updatefromurl*:

![image](https://user-images.githubusercontent.com/16405698/27762904-313b666e-5e8b-11e7-93b0-e01b1bfc36e1.png)

- *msgbox* calls `MessageBoxA`:

![image](https://user-images.githubusercontent.com/16405698/27762929-900ec6ae-5e8b-11e7-913b-4b62545a5d07.png)

- I think *keyinput* and *mclick* are used in keylogger, which is not available in free edition:

![image](https://user-images.githubusercontent.com/16405698/27762954-100fc682-5e8c-11e7-9380-8938bc5b3e68.png)

- *getclipboard*, *setclipboard*, *emptyclipboard* are used to do corresponding work:

![image](https://user-images.githubusercontent.com/16405698/27762970-55adf70e-5e8c-11e7-90d3-85797c1d1475.png)

- *dlldata* and *dllurl* are used to download `dll` from attackers machine and from internet:

![image](https://user-images.githubusercontent.com/16405698/27763004-e0226640-5e8c-11e7-98e0-eb9c33e71879.png)

...and injects without writting on the disk using `CreateFileMappingA` and `MapViewOfFileEx`:

![image](https://user-images.githubusercontent.com/16405698/27763026-2f1d4fc6-5e8d-11e7-97df-3bb950d22011.png)

I think it uses reflective `dll` injection, `LoadLibrarA` and `GetProcAddress` are used to get imports for injected `dll`:

![image](https://user-images.githubusercontent.com/16405698/27763060-ab2fe150-5e8d-11e7-8602-81fd003e8490.png)

- *initregedit* is used to done things in registry:

![image](https://user-images.githubusercontent.com/16405698/27763211-06e6b792-5e90-11e7-86a8-006f927c4b50.png)

Uses functions from `Shlwapi.dll` to manipulate registry:

![image](https://user-images.githubusercontent.com/16405698/27763294-1dd42816-5e92-11e7-908b-173a009ed0e1.png)

- *initremscript* is used to execute scripts from C&C:

![image](https://user-images.githubusercontent.com/16405698/27763247-e9ce862a-5e90-11e7-8c90-a4621c776622.png)

Execute `VBScript`:

![image](https://user-images.githubusercontent.com/16405698/27763267-51abd5c2-5e91-11e7-869a-ecfb023cbe79.png)

- *renamebck* is used to change a value of `name` key at `Software\Remcos-MUTEXval`, which is used as ID:

![image](https://user-images.githubusercontent.com/16405698/27763395-06a087c8-5e94-11e7-81f3-55fd6c2440de.png)

- *OSpower* is used to *sleep, shut down, log off, hibernate, restart* infected machine.

`sleep` using `SetSuspendState`:

![image](https://user-images.githubusercontent.com/16405698/27763447-e96fb57e-5e94-11e7-8ba3-7b508c76924f.png)
Shut down using `ExitWindowsEx`:

![image](https://user-images.githubusercontent.com/16405698/27763542-6ab5dba8-5e96-11e7-8692-0b0285957407.png)

- *initsocks* is used to get SOCKS proxy:

![image](https://user-images.githubusercontent.com/16405698/27763136-0de8592a-5e8f-11e7-867b-717b4dac79d3.png)


Let's see how it sends files and information.
That's data before encryption routine:

![senddatabefire](https://user-images.githubusercontent.com/16405698/27763565-d112ef08-5e96-11e7-82a4-898607a0898c.PNG)

That's encryption routine:

![encryptfunction](https://user-images.githubusercontent.com/16405698/27763571-df7d1e2e-5e96-11e7-9ada-19d01fc887ed.PNG)

That's data after encryption:

![senddataafterenc](https://user-images.githubusercontent.com/16405698/27763573-f0b9941a-5e96-11e7-98ed-0f6155593da1.PNG)

We can inject into malicious application and see data before send using `Echo Mirage`:

![encryptedechomirage](https://user-images.githubusercontent.com/16405698/27763584-216fcac0-5e97-11e7-9f6a-2a5d41bc8442.PNG)

That's same data.


Maybe I overlook something, due to my limited knowledge, if you find something interesting please contact me.

That’s all. I’m new to reversing malware and any kind of feedback will be helpful for me.

Twitter: [@_qaz_qaz](https://twitter.com/_qaz_qaz)
