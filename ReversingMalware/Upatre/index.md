---
layout: REpost
title: "Upatre - Trojan Downloader"
---

You can get the sample from [theZoo](https://github.com/ytisf/theZoo/tree/master/malwares/Binaries/Waski.Upatre "theZoo")

SHA-256: `1b893ca3b782679b1e5d1afecb75be7bcc145b5da21a30f6c18dbddc9c6de4e7`

We can use behavior analysis from [hybrid-analysis](https://www.hybrid-analysis.com/sample/1b893ca3b782679b1e5d1afecb75be7bcc145b5da21a30f6c18dbddc9c6de4e7?environmentId=100 "hybrid-analysis").

![image](https://user-images.githubusercontent.com/16405698/28003882-dd077efc-6551-11e7-9263-0bdcfa479332.png)
Seems like there is no known protection mechanism.

In the strings, there is nothing important other than this base64 encoded string:

![image](https://user-images.githubusercontent.com/16405698/28003935-380ff982-6552-11e7-84c7-194e39ba38ca.png)

...and imports is not eloquent but there is our friend `GetProcAddress`:

![image](https://user-images.githubusercontent.com/16405698/28004002-bf3eed78-6552-11e7-8728-9b051a6f0045.png)

Let's open in `IDA`:

`sub_403760` is used to get necessary Win API functions:

![image](https://user-images.githubusercontent.com/16405698/28004118-64ba89c4-6553-11e7-8306-d38636988974.png)

Inside `sub_403760`, malware decrytes strings and uses `GetProcAddress` to get addresses of functions:

![image](https://user-images.githubusercontent.com/16405698/28004182-e8f3afc2-6553-11e7-870a-5c52216c0259.png)

To decrypt strings before call `GetProcAddress`, `Upatre` uses following decryption routine:

![image](https://user-images.githubusercontent.com/16405698/28004205-1f24273e-6554-11e7-9e1f-74c43cf653ce.png)

Inside `sub_402F30` malware uses this teqnique to get addresses for following Win API functions:

`NtAllocateVirtualMemory`, `NtUnmapViewOfSection`, `CreateThread`, `WaitForSingleObject`, `LoadLibraryA`, `HeapAlloc`, `RtlAllocateHeap`, `RtlDecompressBuffer`, `FlushInstructionCache`, `NtGetContextThread`.

The decryption routine is used heavily by malware in different places to get plain text.

![image](https://user-images.githubusercontent.com/16405698/28004382-4ef316a4-6555-11e7-9a37-c46a29b85c6a.png)

At `00403572`, `Upatre` decodes base64 encoded string and saves at `004051B0`(I renamed variable as `decrypted_bin`):

![image](https://user-images.githubusercontent.com/16405698/28004575-9926f50a-6556-11e7-839e-45b3655c65a8.png)

At `0040386D` it creates a new thread:

![image](https://user-images.githubusercontent.com/16405698/28004654-246a74e8-6557-11e7-908c-be29d9d5129b.png)

Main work starts inside the thread at `00403900`, Where it decryptes and gets addresses for several Win API functions: `CreateProcessW`, `ExitProcess`, `NtWriteVirtualMemory`, `NtSetContextThread`, etc.

![image](https://user-images.githubusercontent.com/16405698/28004717-8bbb2dae-6557-11e7-9925-a62dc7a63e7d.png)


Creates itself as a new process in suspended mode and saves `Context`:

![image](https://user-images.githubusercontent.com/16405698/28005178-47a1b7ca-655a-11e7-994c-0c5829586085.png)

# Anti-Debug:
There is one interesting anti-debug trick, at the start, it saves `PEB` and uses `BeingDebug` value `[PEB+2]` in XOR decryption routine, outside of a debugger this value is `0` and adding `0` don't cause any error, but if we try to add `1` (which is the value of `[PEB+2]` if the executable is inside a debugger) it may cause error. In this case `RtlDecompressBuffer` returns `0xC0000242`(STATUS_BAD_COMPRESSION_BUFFER) error.

The reason of this error is that before calling `RtlDecompressBuffer`, malware decrypts(with XOR) decoded strings using `0x4C+[PEB+2]` which is `0x4D` inside a debugger instead of `0x4C`, because of this result is corrupted output.

![image](https://user-images.githubusercontent.com/16405698/28057051-eaf6c660-662f-11e7-875a-99813c3e6ea4.png)

`[eax+2]` is the value of `BeingDebug`:

![image](https://user-images.githubusercontent.com/16405698/28005497-fd8d25dc-655b-11e7-9bb7-3179ddb921b5.png)

![image](https://user-images.githubusercontent.com/16405698/28005910-02430f4a-655e-11e7-85c5-fd3bf333eca7.png)

We can use `ScyllaHide` plugin for `IDA` to defeat this anti-debug method.

Decompresses decoded and decrypted base64 string using `RtlDecompressBuffer` (format `COMPRESSION_FORMAT_LZNT1`):

![image](https://user-images.githubusercontent.com/16405698/28005361-2f29f9e0-655b-11e7-8102-15dd9c4d2307.png)

...and writes into suspened process:

![image](https://user-images.githubusercontent.com/16405698/28005388-514f8a12-655b-11e7-9863-875e1e20d955.png)

After decompress it calls `NtSetContextThread`, value of `EIP` is `401265`:

![image](https://user-images.githubusercontent.com/16405698/28006134-0c2c1816-655f-11e7-84f8-84d759da86f5.png)

Resumes thread and exits:

![image](https://user-images.githubusercontent.com/16405698/28006172-396b3d98-655f-11e7-9322-a1cf004fbae2.png)

Before `NtResumeProcess` call attach `x32dbg` to child process and set `EIP` to `401265`:

![image](https://user-images.githubusercontent.com/16405698/28006517-a777c7b0-6560-11e7-9d63-cd0a6f2ac16e.png)


Close `IDA` and start analyzing of the child process.

Tries to read `uttE047.tmp` file from `%TEMP%` directory without success:

![image](https://user-images.githubusercontent.com/16405698/28006707-8b7ab8e6-6561-11e7-8134-c1ecca363958.png)

Creates one and writes location of the executable:

![image](https://user-images.githubusercontent.com/16405698/28006819-fd86d17c-6561-11e7-9594-db76da1d0a59.png)

Inside of `uttE047.tmp` file:

![image](https://user-images.githubusercontent.com/16405698/28006882-41fa9ed8-6562-11e7-9c15-408d31f49f5e.png)

Copies executale to `%TEMP%` directory as `utilview.exe`:

![image](https://user-images.githubusercontent.com/16405698/28006956-9c961eb2-6562-11e7-9836-244b4ee04f1f.png)

...and creates as new process:

![image](https://user-images.githubusercontent.com/16405698/28007066-0b8b84d8-6563-11e7-9194-ff629eadb705.png)

This process is exactly same as the first process, creates a new process and injects decoded and decompressed code.

Let's reverse last part (injected code) a little bit higher level.

Now we are here: sample.exe -> sample.exe -> utilview.exe -> **utilview.exe**

The injected code is also same as before it checks `uttE047.tmp` file, but this time there is `uttE047.tmp` in `%TEMP%` directory and malware goes a different direction, reads the content of `uttE047.tmp`, which is the location of the executable and removes that executable:

![image](https://user-images.githubusercontent.com/16405698/28007540-e4499d22-6564-11e7-8b27-2529079b70b6.png)

After this it gets IP of the victim using `checkip.dyndns.com`:

![image](https://user-images.githubusercontent.com/16405698/28007931-73451370-6566-11e7-939c-9a0db7894f79.png)

Also, there is a typo in user-agent string:

![image](https://user-images.githubusercontent.com/16405698/28008836-23189c6a-656a-11e7-83f8-c348d81c160e.png)


and parses IP from returned file:

![image](https://user-images.githubusercontent.com/16405698/28007705-80a32a4e-6565-11e7-94a5-3e33f23231ba.png)

It tries to download `questd.pdf` from `http://penangstreetfood.net/wp-content/uploads/questd.pdf` and `http://yumproject.com/wp-content/uploads/2014/11/questd.pdf` without success.

![image](https://user-images.githubusercontent.com/16405698/28008078-09db2734-6567-11e7-9218-318f0b81ef55.png)

Sends `GET` requests to `95.181.46.38` with client related information, last string derives from victim's IP address, `B` is instead of `.`
![image](https://user-images.githubusercontent.com/16405698/28013604-a412617e-657a-11e7-96fc-b4f2a1b8486d.png)


That's all... `Upatre`'s main function is to download malicious files.

# Note
If you prefer you can use my script to extract payload instead of doing it manually:
<script src="https://gist.github.com/secrary/98c563688fa6cea1fd517170f97988ab.js"></script>

I know, I overlook many things related to `Upatre`, due to my limited knowledge, if you find something interesting please contact me.

Iâ€™m new to reversing malware and any kind of feedback is helpful for me.

Twitter: [@_qaz_qaz](https://twitter.com/_qaz_qaz)
