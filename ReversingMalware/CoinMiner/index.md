---
layout: REpost
title: "CoinMiner"
---


`SHA256` of `sample.exe`: [98199294da32f418964fde49d623aadb795d783640b208b9dd9ad08dcac55fd5](https://www.virustotal.com/en/file/98199294da32f418964fde49d623aadb795d783640b208b9dd9ad08dcac55fd5/analysis/)

Today I'm trying to analyze #CoinMiner, the sample is very interesting because it injects 64-bit process from a 32-bit process, also uses some anti-disassemble and anti-RE techniques.

You can download the sample from [hybrid-analysis](https://www.hybrid-analysis.com/sample/98199294da32f418964fde49d623aadb795d783640b208b9dd9ad08dcac55fd5).

Let's open in VM, after executing it creates folder under `%LOCALAPPDATA%` and writes an executable inside it, uses `RunOnce` reg key as persistence method, creates `notepad.exe` process with following arguments:
`-a cryptonight -o stratum+tcp://xmr-usa.dwarfpool.com:8050 -u 4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbS3d2ZdUYfaKLkAbBLe -p x -t 2`.

<img data-src="https://user-images.githubusercontent.com/16405698/28746533-9a4906e6-749f-11e7-883b-989903a94589.png" class="lazyload" />

(click [here](https://user-images.githubusercontent.com/16405698/28746533-9a4906e6-749f-11e7-883b-989903a94589.png) to view larger version)

Seem like it copies itself to `%LOCALAPPDATA%` folder, executes `notepad.exe` with arguments and injects some third-party code.
That's interesting, the malware itself is 32-bit and `notepad.exe` under the 64-bit system is 64-bit.

Let's dive in deep.

At the beginning it decrypts embedded PE file, using the following routine:

![image](https://user-images.githubusercontent.com/16405698/28746642-f4ab3c8e-74a0-11e7-83dc-29a3e03e5c0a.png)

`byte_882040` points to `4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkN`.

After decryption, it patches decrypted PE file:

![PE_file](https://user-images.githubusercontent.com/16405698/28746719-aac30484-74a1-11e7-836b-6f17f393a948.png)

Decompiled version:

<img data-src="https://user-images.githubusercontent.com/16405698/28746728-ecd21bc6-74a1-11e7-8456-0a1e262d215b.png" class="lazyload" />

(click [here](https://user-images.githubusercontent.com/16405698/28746728-ecd21bc6-74a1-11e7-8456-0a1e262d215b.png) to view a larger version)

After this, it manually maps decrypted PE file into the memory of the current process and jumps into it with `call` instruction.:

![image](https://user-images.githubusercontent.com/16405698/28746808-57c660ea-74a2-11e7-9e5d-a9c3804a7a92.png)

It allocates space, copies headers and sections, corrects import table and relocation table:

![image](https://user-images.githubusercontent.com/16405698/28746818-b3762286-74a2-11e7-9d24-03081bcdfde0.png)

(click [here](https://user-images.githubusercontent.com/16405698/28746818-b3762286-74a2-11e7-9d24-03081bcdfde0.png) to view a larger version)

Start analyzing of `sample2.exe` which is extracted from `sample.exe`.

We can extract decrypted file after patching.

`SHA256` of decrypted PE `sample2.exe`: [f558e28553c70a0c3926c8c77e91c699baa3491922ab9cdfb29aa995138d5a08 ](https://www.virustotal.com/en/file/f558e28553c70a0c3926c8c77e91c699baa3491922ab9cdfb29aa995138d5a08/analysis/1501348947/)

You can download the file from [hybrid-analysis](https://www.hybrid-analysis.com/sample/f558e28553c70a0c3926c8c77e91c699baa3491922ab9cdfb29aa995138d5a08?environmentId=100).

From the beginning of the executable, we see patched strings from the previous executable:

![image](https://user-images.githubusercontent.com/16405698/28746897-7929be9c-74a4-11e7-8234-8313b36e0f4b.png)


Identfies `%LOCALAPPDATA%` folder using `SHGetKnownFolderPath` system call:

![SHGetKnownFolderPath](https://user-images.githubusercontent.com/16405698/28746973-dff3b000-74a5-11e7-8ef6-892a16762eaa.png)

(click [here](https://user-images.githubusercontent.com/16405698/28746973-dff3b000-74a5-11e7-8ef6-892a16762eaa.png) to view larger version)


It allocates a buffer, writes data into it from the file and writes data from the buffer into newly created file under `%LOCALAPPDATA%`

![copy](https://user-images.githubusercontent.com/16405698/28747126-b60ff926-74a8-11e7-852e-3591e223d1e5.png)

(click [here](https://user-images.githubusercontent.com/16405698/28747126-b60ff926-74a8-11e7-852e-3591e223d1e5.png) to view larger version)

Deletes `Zone.Identifier` of the file:

![image](https://user-images.githubusercontent.com/16405698/28747180-f99b33a8-74a9-11e7-8c8e-78d66c1ce5cc.png)

According to `MSDN` it's stream name and used to identify file downloaded from the internet, 3 is internet zone, for more information about `ADS` visit [MSDN](https://blogs.technet.microsoft.com/askcore/2013/03/24/alternate-data-streams-in-ntfs/).

![image](https://user-images.githubusercontent.com/16405698/28747197-60257322-74aa-11e7-84b7-e8669da04d28.png)

Constructs command line arguments and starts searching for a program to inject:

![image](https://user-images.githubusercontent.com/16405698/28747235-39162dde-74ab-11e7-94b6-1edab3091ecc.png)

Based on `IsWow64Process` call it chooses `notepad.exe` or `explorer.exe` on x64 systems and `wuapp.exe` or `svchost.exe` on x32 systems:

![image](https://user-images.githubusercontent.com/16405698/28747263-b3b36a70-74ab-11e7-83f9-98e579b2e68f.png)

(click [here](https://user-images.githubusercontent.com/16405698/28747263-b3b36a70-74ab-11e7-83f9-98e579b2e68f.png) to view a larger version)


On my x64 Windows 10 there is `notepad.exe` under `C:\Windows` and it chooses `notepad.exe` to inject.

It chooses to inject a 32-bit process or a 64-bit one based on `IsWow64Process`:

![image](https://user-images.githubusercontent.com/10502637/28747336-5241e634-74ad-11e7-80a5-e92f52754741.png)

Injecting into 32-bit process it relatively straightforward, there are our old friends `GetThreadContext`, `ReadProcessMemory`, `WriteProcessMemory`, `SetThreadContext` and `ResumeThread`, it's a typical process hollowing:

![image](https://user-images.githubusercontent.com/16405698/28747348-a0517c9a-74ad-11e7-8977-3e29e0552604.png)

(click [here](https://user-images.githubusercontent.com/16405698/28747348-a0517c9a-74ad-11e7-8977-3e29e0552604.png) to view larger version)

But my system is 64-bit, so it chooses to inject into the 64-bit process.

Checks if there is `taskmgr.exe` process and loops until closing it:

![check_taskmgr](https://user-images.githubusercontent.com/16405698/28751058-8eca4af4-750e-11e7-864d-6158d303ffcc.PNG)

It creates `notepad.exe` process with arguments:

![create_notepad](https://user-images.githubusercontent.com/16405698/28751060-8ed89ec4-750e-11e7-9240-2baed54991db.PNG)

(click [here](https://user-images.githubusercontent.com/16405698/28751060-8ed89ec4-750e-11e7-9240-2baed54991db.PNG) to view larger version)

It calls `getNtdll` (I renamed it), but there is an anti-disassemble technique known as `Return Pointer Abuse` and even IDA pro can not identify functions bounders correctly, we should change this using `ALT+P` and set correct end address of the function.

![return_pointer_abuse](https://user-images.githubusercontent.com/16405698/28751067-8f052070-750e-11e7-9bc8-2d77785fa6e3.PNG)

After correcting bounders and patching `call $+5; mov; retf;` instructions,  which are just jumping to next addresses, at some point it checks modules and gets an address of `ntdll.dll`, this is 64-bit `dll` loaded by `notepad.exe`.
`ESI:EDI` contains the address of `ntdll.dll`, to prove this we can use `vmmap`:

![ntdll_addr](https://user-images.githubusercontent.com/16405698/28751064-8ef73d8e-750e-11e7-9c8a-97ef861b74cd.PNG)

(click [here](https://user-images.githubusercontent.com/16405698/28751064-8ef73d8e-750e-11e7-9c8a-97ef861b74cd.PNG) to view larger version)

It uses `getFunction` (I renamed it) to get addresses of functions exported by `ntdll.dll`:

![getFunction](https://user-images.githubusercontent.com/16405698/28751062-8edb586c-750e-11e7-9791-9a2cd0b10661.PNG)

Inside that function it uses `LdrProcedureAddress` call to get address of desire function, it passes `LdrProcedureAddress` to `call_ebp_8` function:

![call_ebp_1](https://user-images.githubusercontent.com/16405698/28751014-ec8d3a08-750d-11e7-881a-3eded59df689.PNG)

`call_ebp_8` calls function at first and second parameters (first:second), also all required parameters are pushed. this way it calls functions exported by `ntdll.dll`.
In this case `call_ebp_8` calls `LdrProcedureAddress` and gets address of requested function:

![call_ebp_8_2](https://user-images.githubusercontent.com/16405698/28751057-8ec37990-750e-11e7-83ff-1fe19022c90e.PNG)

The malware uses `getNtdll` to get address of 64-bit `ntdll.dll`, `call_ebp_8` to call functions exported by `ntdll.dll` and `getFunction` to get addresses of desire function from `ntdll.dll`, `getFunction` uses `call_ebp_8` with `LdrProcedureCall` as a function argument.

![sum_call](https://user-images.githubusercontent.com/16405698/28751068-8f0a3d1c-750e-11e7-9722-5ec8235ef8d1.PNG)

Using this functions it calls `NtGetContextThread`, `NtReadVirtualMemory`, `NtAllocateVirtualMemory`, `NtWriteVirtualMemory` and `ResumeThread`, as we know this functions are essential for process hollowing.
After setting of `CONTEXT` it resumes thread:

![resume_thread](https://user-images.githubusercontent.com/16405698/28751066-8f049c04-750e-11e7-8dec-bb6fdeb69e7a.PNG)

Everything this happens in a loop, if we close `notepad.exe` process it creates one again.

We can easily extract 32-bit and 64-bit PE files, which are injected into a target process.
We can extract it before calling to `NtWriteVirtualMemory`:

![extract_pe](https://user-images.githubusercontent.com/16405698/28751061-8ed8f4f0-750e-11e7-8f80-4ecafff306eb.PNG)

Both 32-bit and 64-bit versions are packed using `UPX`.
After unpacking it, we can disassemble it:

![upx_free](https://user-images.githubusercontent.com/16405698/28751069-8f1892c2-750e-11e7-8aa6-d96c9819acdf.PNG)

It's [cpuminer](https://github.com/pooler/cpuminer): A CPU miner for Litecoin, Bitcoin, and other cryptocurrencies, the application to use CPU power to compute hashes and `"mine"` cryptocurrency:

![cpuminer_](https://user-images.githubusercontent.com/16405698/28751059-8ece225a-750e-11e7-87cf-d3934ec9ef54.PNG)

The malware uses following arguments: `-a cryptonight -o stratum+tcp://xmr-usa.dwarfpool.com:8050 -u 4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbS3d2ZdUYfaKLkAbBLe -p x -t 2`

`-a` - specify the algorithm to use.

`-o` - URL of mining server.

`-u` - username.

`-p` - password.

`-t` - number of miner threads.



The malware heavily uses anti-RE techniques which make analysis harder.

I know, I overlook many things related to the malware, due to my limited knowledge, if you find something interesting please contact me.

Iâ€™m new to reversing malware and any kind of feedback is helpful for me..

Twitter: [@_qaz_qaz](https://twitter.com/_qaz_qaz)
