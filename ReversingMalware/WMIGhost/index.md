---
layout: post
title: "WMIGhost / Wimmie - WMI malware"
---

WMIGhost / Wimmie sample is from [theZoo](https://github.com/ytisf/theZoo/tree/master/malwares/Binaries/WMIGhost "theZoo")

SHA256: `a6ff8dfe654da70390cd71626cdca8a6f6a0d7980cd7d82269373737b04fd206`

The sample has `.dll` extension but there are no exports and according to characteristics, it's not `dll` file, I've changed the extension to `.exe`

![image](https://user-images.githubusercontent.com/16405698/28249223-7e2a074a-6a62-11e7-976a-4c99a96e8829.png)

We can use the report from [hybrid-analysis](https://www.hybrid-analysis.com/sample/a6ff8dfe654da70390cd71626cdca8a6f6a0d7980cd7d82269373737b04fd206?environmentId=100 "hybrid-analysis").

There is no protection, let's dive in deep.

![image](https://user-images.githubusercontent.com/16405698/28249243-f385b11a-6a62-11e7-91d2-5bbe286f6db7.png)

From the beginning, it decrypts text using `XOR` with `0x63` and `0xE9`:

![image](https://user-images.githubusercontent.com/16405698/28249284-a3812ffe-6a63-11e7-927e-95a8e3963fc4.png)

Decrypted text:

Raw format- [Gist link](https://gist.github.com/secrary/8705c3cf184aec54f370c5704742602d "Gist link")

Much more readable: [Gist Link](https://gist.github.com/secrary/a67efdd15cdddc5e39fa2ce75fcf16c9 "Gist Link")

![image](https://user-images.githubusercontent.com/16405698/28249405-ffb4522c-6a65-11e7-8858-8f15a2c0ae2f.png)


`NOTE`: you can use my script to extract decrypted text from the executable: [Gist link](https://gist.github.com/secrary/c4fd3273a24da449795cc47f2e4378ef "Gist link").

The malware uses `CoCreateInstance` function to get access to `COM` functionality.

The Microsoft Component Object Model (COM) is an interface standard that
makes it possible for different software components to call each other’s code
without knowledge of specifics about each other.

![image](https://user-images.githubusercontent.com/16405698/28249341-fc4b15cc-6a64-11e7-97e6-1f7eb4b93cbd.png)


`MS Script Control` is provided in `msscript.ocx`. It is a very handy tool to run VBScript/JScript without relying on `CScript.exe` or `WScript.exe`.

Seems like malware uses `Script Control` via `COM` to execute decrypted function without `CScript.exe` or `WScript.exe`.


`call dword ptr[ecx+20h]` calls some function from `msscript.ocx`, but I have no idea which function, there are no symbols, but I think it chooses `javascript` to execute the script:

![image](https://user-images.githubusercontent.com/16405698/28249463-6871beac-6a67-11e7-94ad-945a832fa954.png)

(Click [here](https://user-images.githubusercontent.com/16405698/28249463-6871beac-6a67-11e7-94ad-945a832fa954.png) to view a larger version)

![image](https://user-images.githubusercontent.com/16405698/28249433-b4a4040c-6a66-11e7-84e8-a34dbbd94b0f.png)

After this at `00401AB7` there is another call to function from `msscript.ocx`:

![image](https://user-images.githubusercontent.com/16405698/28249497-f88cd2ba-6a67-11e7-806b-212657d531ab.png)

I think this function is used to execute the script because it causes creation of new process `scrcons.exe`

![image](https://user-images.githubusercontent.com/16405698/28249510-3b7196e2-6a68-11e7-80c1-168c27ec7254.png)

According to `TrendMicro`'s great [paper](https://www.trendmicro.de/cloud-content/us/pdfs/security-intelligence/white-papers/wp__understanding-wmi-malware.pdf "paper"):

`Based on our analysis of using JS, the application wscript.exe is responsible for executing the malicious code. However, in the case of WMI implementation, such a script is executed by the WMI Standard Event Consumer - scripting application, which can be found in the WMI folder in %system32%/ wbem/scrcons.exe. This makes the script hard to detect since it uses a not-so-common WMI application—scrcons.exe—rather than the traditional JS application—wscript.exe.`

Yes, the sample uses `WMI` and executes the script using `scrcons.exe`.

After creation of the new process, it also creates `httpcom.log` file and writes infection date:

![image](https://user-images.githubusercontent.com/16405698/28249621-2ca2350c-6a6a-11e7-99c5-8bd9df759f48.png)


Before exit it tries to delete `instell.exe` without success:

![image](https://user-images.githubusercontent.com/16405698/28249576-6fcd482c-6a69-11e7-9963-6eef868d83d9.png)


That's executable, let's look at the [script](https://gist.github.com/secrary/8153a0cb8b4954429e1c430ad4821f96 "script"):

![image](https://user-images.githubusercontent.com/16405698/28249667-413e6bba-6a6b-11e7-93a3-d66baabe0716.png)

(Click [here](https://user-images.githubusercontent.com/16405698/28249667-413e6bba-6a6b-11e7-93a3-d66baabe0716.png) to view a larger version)

It creates instance of `ActiveScriptEventConsumer` under `root\subscription` namespace, executes `Javascript` script every `0x6e3` milliseconds , you can get the script from the [Gist](https://gist.github.com/secrary/a67efdd15cdddc5e39fa2ce75fcf16c9 "Gist") or get using [`WMI Explorer`](https://wmie.codeplex.com/ "`WMI Explorer`"), it's under `ROOT\subscription` namespace, the class is `ActiveScriptEventConsumer`, the name of the instance is `ProbeScriptFint`, the script is a value of the `ScriptText` property.

![image](https://user-images.githubusercontent.com/16405698/28249657-01e2eb12-6a6b-11e7-8f9b-1d965588f3fd.png)

(Click [here](https://user-images.githubusercontent.com/16405698/28249657-01e2eb12-6a6b-11e7-8f9b-1d965588f3fd.png) to view a larger version)

WMI classes stored in namespace: `subscription` allow permanent and general access to
WMI services. 

`new MAIN().Fire()` causes executing of `MAIN` routine:

![image](https://user-images.githubusercontent.com/16405698/28249735-835bb9e8-6a6c-11e7-9db0-e7a133dc98d1.png)

`CleanObjects` terminates execution of the script:

![image](https://user-images.githubusercontent.com/16405698/28249752-c41a1e48-6a6c-11e7-97bc-ef4223e2a3b5.png)

Parses URLs from the argument and sends information about infected PC:

![image](https://user-images.githubusercontent.com/16405698/28249779-4087c6e2-6a6d-11e7-850d-01fc7436b96c.png)

![image](https://user-images.githubusercontent.com/16405698/28249788-62d7e5ec-6a6d-11e7-8084-f9fb00224923.png)

Receives commands and sends results:

![image](https://user-images.githubusercontent.com/16405698/28249794-9d6dbe0c-6a6d-11e7-804d-95c2408cdee0.png)

![image](https://user-images.githubusercontent.com/16405698/28249803-e3a16aa4-6a6d-11e7-9e5f-a6c8fddadce3.png)

If you prefer you can dive deeper into the script, it's not obfuscated and is easy to analyze.

That's all... WMIGhost / Wimmie is a very interesting malware, it uses `WMI` to achieve persistence and get system related information, the script is not on the disk.

We can get information about `WMI Database Entries` using `Autoruns`:

![image](https://user-images.githubusercontent.com/16405698/28249882-5c6286b6-6a6f-11e7-9a09-0877bc162a2a.png)

Maybe I overlook something related to `WMIGhost`, due to my limited knowledge, if you find something interesting please contact me.

I’m new to reversing malware and any kind of feedback is helpful for me.

Twitter: [@_qaz_qaz](https://twitter.com/_qaz_qaz)

**Resources**:

[Understanding WMI Malware](https://www.trendmicro.de/cloud-content/us/pdfs/security-intelligence/white-papers/wp__understanding-wmi-malware.pdf "Understanding WMI Malware")




