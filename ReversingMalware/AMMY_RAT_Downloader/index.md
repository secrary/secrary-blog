---
layout: post
title: "A Brief Overview of the AMMYY RAT Downloader"
---

SHA-256: [963f1735e9ee06c66fdf3a831d7c262bc8bce0d7155e37f9a5aa2677e0a6090c](https://www.virustotal.com/#/file/963f1735e9ee06c66fdf3a831d7c262bc8bce0d7155e37f9a5aa2677e0a6090c/detection)

You can download the malware sample from [malware-traffic-analysis.net](https://malware-traffic-analysis.net/2018/05/25/index.html)

# Stage 1

The main function is full of junk instructions, the most interesting function inside the `main` is `decode_n_call` function near the end:

![1](https://user-images.githubusercontent.com/16405698/41530771-b5f3355c-72e0-11e8-89cd-9c0aab2483ef.PNG)

Inside the `decode_n_call` function, it allocated memory, decodes a data from `0x0433220` address and jumps to it via `call` instruction:

![2](https://user-images.githubusercontent.com/16405698/41530774-b64df87a-72e0-11e8-91d0-18ec0ab2f738.png)

![3](https://user-images.githubusercontent.com/16405698/41530896-193847ce-72e1-11e8-9686-68e347e5f64b.gif)

It allocates two memory blocks, each `0x3000` length, with `PAGE_EXECUTE_READWRITE` permission:

![4](https://user-images.githubusercontent.com/16405698/41530775-b6a7125c-72e0-11e8-9cd0-a44e2a24fa7b.PNG)

After that, it writes some decoded data inside the first allocated memory:

![5](https://user-images.githubusercontent.com/16405698/41530897-1ad00f90-72e1-11e8-9e07-531578b07dab.gif)

Also, there is another loop which decodes/decrypts once again the written data in the memory:

![6](https://user-images.githubusercontent.com/16405698/41530899-1b1fe222-72e1-11e8-9ab7-2234be8770db.gif)

Seems like it's `PE` file, but still encoded, not valid yet.

Function `0x30A70` gets two arguments, the encoded/encrypted data and the second allocated memory, the function returns a decoded/decrypted `PE` file via the second argument:

![7](https://user-images.githubusercontent.com/16405698/41530900-1b51cad0-72e1-11e8-8976-c739e2efd79c.gif)

It removes the `main` executable from the memory and copies recently decoded/decrypted code:

![8](https://user-images.githubusercontent.com/16405698/41530901-1b87c16c-72e1-11e8-8b44-dfb94bc5ac92.gif)

Section maps:

![9](https://user-images.githubusercontent.com/16405698/41530776-b6fe3780-72e0-11e8-95ff-da62d118d39f.PNG)

Inside `0x30730` (offset `0x730`) function it build IAT for the new `PE` file:

![10](https://user-images.githubusercontent.com/16405698/41530777-b7606ef0-72e0-11e8-8da5-6f3c312b1957.PNG)

After that, it jumps to the entry point of the new `PE` file:

![11](https://user-images.githubusercontent.com/16405698/41530902-1bb8683a-72e1-11e8-9575-7fe85e4c24e9.gif)

Instead of continuing analysis, it's much easier to dump the new `PE` and analyze it separately.

# Stage 2

The second `PE` is full of junk instructions, too.
The interesting part starts at `0x0401EED` location.

![12](https://user-images.githubusercontent.com/16405698/41530778-b7da7c86-72e0-11e8-8b62-51a2e1239ef3.PNG)

Inside the `sub_403B10` function, it tries to delete `Settings`, `Microsoft\\Enc`, `AMMYY`, `Foundation` and `Foundation1` directories, also following files: `wmihost.exe`, `settings3.bin`, `wmites.exe`, `wsus` from different directories:

![13](https://user-images.githubusercontent.com/16405698/41530779-b817fbec-72e0-11e8-84d8-fc3deb3dc8d4.PNG)

It uses `sub_404450` to get a function addresses based on some kind of hash, which is passed via the second argument:

![14](https://user-images.githubusercontent.com/16405698/41530905-1c74c7b4-72e1-11e8-84f8-6472feec9e20.gif)

The `0x403DE0` function gets process name as the argument and terminates the corresponding process:

![16](https://user-images.githubusercontent.com/16405698/41530782-b8827dd2-72e0-11e8-8677-24527f518f48.PNG)

![15](https://user-images.githubusercontent.com/16405698/41530780-b84cfe32-72e0-11e8-91a9-124f56af1b4c.PNG)

It executes following commands using `ShellExecuteW` function: `cmd /C net.exe stop ammyy`, `cmd /C sc delete ammyy`, `cmd /C net.exe stop foundation` and `cmd /C sc delete foundation`

![17](https://user-images.githubusercontent.com/16405698/41530746-aefa3dfe-72e0-11e8-89e0-8ff3b98779f5.PNG)

These commands stop the malware if there is one.

It generates random name (via `CoCreateGuid`) for a `PE` file, which it downloads from `http://185.176.221.29/ban3.dat`:

![18](https://user-images.githubusercontent.com/16405698/41530747-af2eccae-72e0-11e8-95b6-546ee3079c54.PNG)

Inside `downloadNextStage_bin` function, it downloads a file from the URL and saves at above-mentionshed location:

![19](https://user-images.githubusercontent.com/16405698/41530748-af9deb2a-72e0-11e8-82ad-d85f2d59048e.PNG)

It copies the new file to `CSIDL_COMMON_APPDATA\Microsoft Help\\wsus.exe` and deletes original one:

![20](https://user-images.githubusercontent.com/16405698/41530750-afd00434-72e0-11e8-8833-8703c0592eb0.PNG)

Inside `sub_402960` function if the user is an `admin`,  it executes above-mentioned commands once again, registers the downloaded `PE` file as a service called `foundation` and starts it:

![21](https://user-images.githubusercontent.com/16405698/41530754-b1266bc0-72e0-11e8-991a-1ac7fc8b1112.PNG)

![22](https://user-images.githubusercontent.com/16405698/41530757-b226786c-72e0-11e8-8929-17fad5a4ba20.PNG)

In the end, it deletes the original, second stage `PE` file:

![23](https://user-images.githubusercontent.com/16405698/41530760-b3025ce2-72e0-11e8-99fb-d0cbfe8288ed.PNG)

If the user is not an `admin`, it uses a COM object (`taskscd.dll`) to create and run the executable (via `scheduled task`):

![24](https://user-images.githubusercontent.com/16405698/41530762-b3e55c0e-72e0-11e8-8ec5-166d2e0a500c.PNG)

![26](https://user-images.githubusercontent.com/16405698/41530764-b44410aa-72e0-11e8-9053-9c872bf18eef.PNG)

For the more detailed information look at `sub_402360` function.

After that, same happens, it deletes the original, second stage `PE` file and exist via `TerminateProcess` call:

![27](https://user-images.githubusercontent.com/16405698/41530767-b4a199be-72e0-11e8-8dda-d436aec9cd9f.PNG)

That's all.

That was the brief overview of the `AMMYY RAT Downloader`.

Thank you for your time.

Discuss on [Reddit](https://www.reddit.com/r/ReverseEngineering/comments/8ryy2u/a_brief_overview_of_the_ammyy_rat_downloader/)

Twitter: [@_qaz_qaz](https://twitter.com/_qaz_qaz)