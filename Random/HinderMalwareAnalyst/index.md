---
layout: post
title: "Hinder na√Øve malware analysts with change of code execution path"
---
![singlestepping](https://user-images.githubusercontent.com/16405698/35236536-20a5a44a-ffc1-11e7-8343-e07c9f088ad9.gif)

These techniques are not complicated ones, but still can confuse some beginner malware analysts and/or reverse engineers.
Change of code execution path using `SEH` (`Structured Exception Handling`) is common in malware samples, a simple example is following:

![SEH](https://user-images.githubusercontent.com/16405698/35212384-5f807558-ff73-11e7-9814-f9c482c62ef1.PNG)

If he/she single steps, he/she will lose control.

But there are other ways to get similar results using Windows API functions with callbacks, we can use these callbacks to hinder an analyst.

`ReadFileEx`/`WriteFileEx` are asynchronous analogies for `ReadFile` and `WriteFile`, the interesting part is that is calls `lpCompletionRoutine` completion routine when writing/reading is completed or canceled:

![WriteFileEx](https://user-images.githubusercontent.com/16405698/35212457-a5f20a56-ff73-11e7-8a0c-fb1eeb19bf33.gif)

<script src="https://gist.github.com/anonymous/68e98968e53be7aa2da68d9a8cd5e91a.js"></script>

Same there, he/she loses control.

What about `EnumDisplayMonitors`? 

![EnumDisplayMonitors](https://user-images.githubusercontent.com/16405698/35212481-bbf9d86a-ff73-11e7-8bf8-c70315685754.gif)

`Note`: We can stop the enumeration with return FALSE.


What about `EnumWindowStations`, `EnumDesktops`, `EnumDesktopWindows`, `EnumThreadWindows`, `EnumWindows`, `EnumChildWindows`, `EnumResourceTypes/Ex`, `EnumResourceNames/Ex`, `EnumResourceLanguages/Ex`, `EnumDirTree`, `EnumThreadWindows`, `AddSecureMemoryCacheCallback`, `SetThreadpoolTimer/Ex`, `SetThreadpoolThreadMinimum`, `SetThreadpool`, `StackWalk64/Ex`, `EnumerateLoadedModulesEx`, `EnumerateLoadedModules64`  and so on, there are many of them, just play with `MSDN` little bit.

![EnumerateLoadedModules64](https://user-images.githubusercontent.com/16405698/35212488-c5a45d0e-ff73-11e7-9147-0d0707ff7754.gif)

<script src="https://gist.github.com/anonymous/c4e3d4499cb3f4ecceac6d7dd70c60f6.js"></script>